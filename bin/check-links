#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

excludes=()
if [[ "${GITHUB_HEAD_REF:-}" = prepare-release-* ]]; then
  excludes+=(--exclude https://github.com/cerbos/cerbos-sdk-ruby/compare/)
fi

docker run \
  --interactive \
  --rm \
  --env GITHUB_TOKEN \
  --mount "type=bind,source=${PWD},target=/input" \
  --workdir /input \
  lycheeverse/lychee:0.22.0-alpine \
  "${excludes[@]}" \
  --exclude-path vendor/bundle \
  --include-fragments \
  --max-concurrency 8 \
  --no-ignore \
  --remap "^https://cerbos\.github\.io/cerbos-sdk-ruby$ file:///input/doc/index.html" \
  --remap "^https://cerbos\.github\.io/cerbos-sdk-ruby/ file:///input/doc/" \
  --root-dir /input \
  --verbose \
  .
