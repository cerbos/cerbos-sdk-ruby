#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

excludes=(--exclude https://www.rubydoc.info/gems/cerbos) # https://github.com/docmeta/rubydoc.info/issues/209
if [[ "${GITHUB_HEAD_REF:-}" = prepare-release-* ]]; then
  excludes+=(--exclude https://github.com/cerbos/cerbos-sdk-ruby/compare/)
fi

docker run \
  --interactive \
  --rm \
  --env GITHUB_TOKEN \
  --mount "type=bind,source=${PWD},target=/input" \
  --workdir /input \
  lycheeverse/lychee:latest-alpine \
  "${excludes[@]}" \
  --exclude-path vendor/bundle \
  --include-fragments \
  --max-concurrency 8 \
  --no-ignore \
  --root-dir /input \
  .
